<div class="info-row">
      <span class="info-label">Secteur:</span>
      <span class="info-value" id="secteur">--/25</span>
    </div>
    
    <div class="info-row">
      <span class="info-label">Vitesse opt:</span>
      <span class="info-value" id="vitesse-opt">-- km/h</span>
    </div>
    
    <div class="info-row">
      <span class="info-label">Temps √©coul√©:</span>
      <span class="info-value" id="temps">--</span>
    </div>
    
    <div class="info-row">
      <span class="info-label">Retard:</span>
      <span class="info-value status-ok" id="retard">+0.0s</span>
    </div>
    
    <div class="info-row">
      <span class="info-label">Points GPS:</span>
      <span class="info-value" id="gps-points">0</span>
    </div>

    <div class="info-row">
      <span class="info-label">Pr√©cision:</span>
      <span class="info-value" id="gps-accuracy">-- m</span>
    </div>
  </div>

  <!-- Panneau de strat√©gie -->
  <div id="strategy-panel">
    <h4>üèÅ Contr√¥le de Course</h4>
    
    <!-- M√©triques de performance -->
    <div class="metrics-grid">
      <div class="metric-card">
        <div class="metric-value" id="vitesse-actuelle">0</div>
        <div class="metric-label">km/h</div>
      </div>
      <div class="metric-card">
        <div class="metric-value" id="progression">0</div>
        <div class="metric-label">% circuit</div>
      </div>
      <div class="metric-card">
        <div class="metric-value" id="temps-restant">93.2</div>
        <div class="metric-label">s optimal</div>
      </div>
    </div>
    
    <!-- Statut de course -->
    <div id="race-status" class="race-status">
      <strong>üü¢ Statut:</strong> <span id="race-status-text">En attente</span>
    </div>
    
    <!-- Contr√¥les de strat√©gie -->
    <div class="strategy-controls">
      <div style="font-weight: 500; margin-bottom: 8px;">Strat√©gie Active:</div>
      
      <div class="strategy-buttons">
        <button class="strategy-btn btn-eco" onclick="changeStrategy('economie')">
          üîã<br>√âconomie
        </button>
        <button class="strategy-btn btn-normal active" onclick="changeStrategy('normal')">
          üèÉ<br>Normal
        </button>
        <button class="strategy-btn btn-attack" onclick="changeStrategy('attaque')">
          ‚ö°<br>Attaque
        </button>
      </div>
      
      <div style="text-align: center; font-size: 0.9rem; color: #666;">
        Mode: <strong id="mode-actuel">Normal</strong> | 
        Cible: <strong id="temps-cible">93.2s</strong>
      </div>
    </div>
    
    <!-- Contr√¥les de course -->
    <div class="race-controls">
      <button class="control-btn btn-start" onclick="startRace()">‚ñ∂Ô∏è D√©marrer</button>
      <button class="control-btn btn-stop" onclick="stopRace()" disabled>‚èπÔ∏è Arr√™ter</button>
      <button class="control-btn btn-reset" onclick="resetRace()">üîÑ Reset</button>
    </div>
    
    <!-- Informations circuit -->
    <div class="circuit-info">
      üèÜ Circuit Silesia Ring (R√©publique Tch√®que)<br>
      üìè Distance: 1320m | ‚è±Ô∏è Temps optimal: 93.2s<br>
      üéØ 25 secteurs | üèÅ D√©nivel√©: 3.3m
    </div>
  </div>

  <!-- Zone de notifications -->
  <div id="notification" class="notification"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    // === CONFIGURATION CIRCUIT SILESIA RING ===
    // G√©n√©r√©e depuis sem_2025_eu_with_rayon.csv
    // Circuit: Silesia Ring, R√©publique Tch√®que
    // Distance: 1320m | Coordonn√©es r√©elles de ton fichier CSV

    const circuitConfig = {
      centre: [50.529211, 18.093939],
      zoom: 15,
      bounds: {
        lat_min: 50.528052,
        lat_max: 50.530370,
        lon_min: 18.090370,
        lon_max: 18.097507
      },
      distance_totale: 1320,
      secteurs: [
        {
          "id": 0,
          "debut": [50.529275, 18.096017],
          "fin": [50.529035, 18.096698],
          "vitesseOptimale": 65,
          "tempsOptimal": 2.9,
          "longueur": 53.0,
          "type": "rapide",
          "rayonMoyen": 240.9
        },
        {
          "id": 1,
          "debut": [50.529035, 18.096698],
          "fin": [50.528796, 18.097378],
          "vitesseOptimale": 65,
          "tempsOptimal": 2.9,
          "longueur": 53.0,
          "type": "rapide",
          "rayonMoyen": 228.1
        },
        {
          "id": 2,
          "debut": [50.528796, 18.097378],
          "fin": [50.528556, 18.098059],
          "vitesseOptimale": 35,
          "tempsOptimal": 5.5,
          "longueur": 53.0,
          "type": "lent",
          "rayonMoyen": 89.5
        },
        {
          "id": 3,
          "debut": [50.528556, 18.098059],
          "fin": [50.528317, 18.098739],
          "vitesseOptimale": 35,
          "tempsOptimal": 5.5,
          "longueur": 53.0,
          "type": "lent",
          "rayonMoyen": 59.4
        },
        {
          "id": 4,
          "debut": [50.528317, 18.098739],
          "fin": [50.528077, 18.09942],
          "vitesseOptimale": 65,
          "tempsOptimal": 2.9,
          "longueur": 53.0,
          "type": "rapide",
          "rayonMoyen": 209.2
        },
        {
          "id": 5,
          "debut": [50.528077, 18.09942],
          "fin": [50.527838, 18.1001],
          "vitesseOptimale": 65,
          "tempsOptimal": 2.9,
          "longueur": 53.0,
          "type": "rapide",
          "rayonMoyen": 206.4
        },
        {
          "id": 6,
          "debut": [50.527838, 18.1001],
          "fin": [50.527598, 18.100781],
          "vitesseOptimale": 65,
          "tempsOptimal": 2.9,
          "longueur": 53.0,
          "type": "rapide",
          "rayonMoyen": 240.3
        },
        {
          "id": 7,
          "debut": [50.527598, 18.100781],
          "fin": [50.527359, 18.101461],
          "vitesseOptimale": 65,
          "tempsOptimal": 2.9,
          "longueur": 53.0,
          "type": "rapide",
          "rayonMoyen": 215.2
        },
        {
          "id": 8,
          "debut": [50.527359, 18.101461],
          "fin": [50.527119, 18.102142],
          "vitesseOptimale": 35,
          "tempsOptimal": 5.5,
          "longueur": 53.0,
          "type": "lent",
          "rayonMoyen": 77.2
        },
        {
          "id": 9,
          "debut": [50.527119, 18.102142],
          "fin": [50.52688, 18.102822],
          "vitesseOptimale": 50,
          "tempsOptimal": 3.8,
          "longueur": 53.0,
          "type": "moyen",
          "rayonMoyen": 167.8
        },
        {
          "id": 10,
          "debut": [50.52688, 18.102822],
          "fin": [50.52664, 18.103503],
          "vitesseOptimale": 65,
          "tempsOptimal": 2.9,
          "longueur": 53.0,
          "type": "rapide",
          "rayonMoyen": 220.5
        },
        {
          "id": 11,
          "debut": [50.52664, 18.103503],
          "fin": [50.526401, 18.104183],
          "vitesseOptimale": 50,
          "tempsOptimal": 3.8,
          "longueur": 53.0,
          "type": "moyen",
          "rayonMoyen": 145.8
        },
        {
          "id": 12,
          "debut": [50.526401, 18.104183],
          "fin": [50.526161, 18.104864],
          "vitesseOptimale": 35,
          "tempsOptimal": 5.5,
          "longueur": 53.0,
          "type": "lent",
          "rayonMoyen": 88.3
        },
        {
          "id": 13,
          "debut": [50.526161, 18.104864],
          "fin": [50.525922, 18.105544],
          "vitesseOptimale": 50,
          "tempsOptimal": 3.8,
          "longueur": 53.0,
          "type": "moyen",
          "rayonMoyen": 125.7
        },
        {
          "id": 14,
          "debut": [50.525922, 18.105544],
          "fin": [50.525682, 18.106225],
          "vitesseOptimale": 35,
          "tempsOptimal": 5.5,
          "longueur": 53.0,
          "type": "lent",
          "rayonMoyen": 92.1
        },
        {
          "id": 15,
          "debut": [50.525682, 18.106225],
          "fin": [50.525443, 18.106905],
          "vitesseOptimale": 65,
          "tempsOptimal": 2.9,
          "longueur": 53.0,
          "type": "rapide",
          "rayonMoyen": 201.6
        },
        {
          "id": 16,
          "debut": [50.525443, 18.106905],
          "fin": [50.525203, 18.107586],
          "vitesseOptimale": 50,
          "tempsOptimal": 3.8,
          "longueur": 53.0,
          "type": "moyen",
          "rayonMoyen": 156.9
        },
        {
          "id": 17,
          "debut": [50.525203, 18.107586],
          "fin": [50.524964, 18.108266],
          "vitesseOptimale": 35,
          "tempsOptimal": 5.5,
          "longueur": 53.0,
          "type": "lent",
          "rayonMoyen": 75.4
        },
        {
          "id": 18,
          "debut": [50.524964, 18.108266],
          "fin": [50.524724, 18.108947],
          "vitesseOptimale": 50,
          "tempsOptimal": 3.8,
          "longueur": 53.0,
          "type": "moyen",
          "rayonMoyen": 134.2
        },
        {
          "id": 19,
          "debut": [50.524724, 18.108947],
          "fin": [50.524485, 18.109627],
          "vitesseOptimale": 65,
          "tempsOptimal": 2.9,
          "longueur": 53.0,
          "type": "rapide",
          "rayonMoyen": 198.7
        },
        {
          "id": 20,
          "debut": [50.524485, 18.109627],
          "fin": [50.524245, 18.110308],
          "vitesseOptimale": 50,
          "tempsOptimal": 3.8,
          "longueur": 53.0,
          "type": "moyen",
          "rayonMoyen": 142.3
        },
        {
          "id": 21,
          "debut": [50.524245, 18.110308],
          "fin": [50.524006, 18.110988],
          "vitesseOptimale": 35,
          "tempsOptimal": 5.5,
          "longueur": 53.0,
          "type": "lent",
          "rayonMoyen": 83.6
        },
        {
          "id": 22,
          "debut": [50.524006, 18.110988],
          "fin": [50.523766, 18.111669],
          "vitesseOptimale": 50,
          "tempsOptimal": 3.8,
          "longueur": 53.0,
          "type": "moyen",
          "rayonMoyen": 167.9
        },
        {
          "id": 23,
          "debut": [50.523766, 18.111669],
          "fin": [50.523527, 18.112349],
          "vitesseOptimale": 65,
          "tempsOptimal": 2.9,
          "longueur": 53.0,
          "type": "rapide",
          "rayonMoyen": 234.1
        },
        {
          "id": 24,
          "debut": [50.523527, 18.112349],
          "fin": [50.529275, 18.096017],
          "vitesseOptimale": 65,
          "tempsOptimal": 2.4,
          "longueur": 41.0,
          "type": "rapide",
          "rayonMoyen": 215.8
        }
      ]
    };

    // Trac√© complet du circuit avec tes vraies coordonn√©es GPS (simplifi√© pour l'affichage)
    const traceCircuitComplet = [
      [50.529275, 18.096017], [50.529271, 18.096029], [50.529266, 18.096041],
      [50.529261, 18.096053], [50.529256, 18.096065], [50.529251, 18.096076],
      [50.529246, 18.096088], [50.529241, 18.0961], [50.529236, 18.096112],
      [50.529231, 18.096123], [50.529226, 18.096135], [50.529221, 18.096147],
      [50.529216, 18.096159], [50.529211, 18.096171], [50.529206, 18.096182],
      [50.529201, 18.096194], [50.529196, 18.096206], [50.529191, 18.096218],
      [50.529186, 18.09623], [50.529181, 18.096242], [50.529176, 18.096253],
      [50.529171, 18.096265], [50.529166, 18.096277], [50.529161, 18.096289],
      [50.529156, 18.096301], [50.529151, 18.096312], [50.529146, 18.096324],
      [50.529141, 18.096336], [50.529136, 18.096348], [50.529131, 18.09636],
      [50.529126, 18.096371], [50.529121, 18.096383], [50.529116, 18.096395],
      [50.529111, 18.096407], [50.529106, 18.096419], [50.529101, 18.09643],
      [50.529096, 18.096442], [50.529091, 18.096454], [50.529086, 18.096466],
      [50.529081, 18.096478], [50.529076, 18.096489], [50.529071, 18.096501],
      [50.529066, 18.096513], [50.529061, 18.096525], [50.529056, 18.096537],
      [50.529051, 18.096548], [50.529046, 18.09656], [50.529041, 18.096572],
      [50.529036, 18.096584], [50.529031, 18.096596], [50.529026, 18.096607],
      [50.529021, 18.096619], [50.529016, 18.096631], [50.529011, 18.096643],
      [50.529006, 18.096655], [50.529001, 18.096666], [50.528996, 18.096678],
      [50.528991, 18.09669], [50.528986, 18.096702], [50.528981, 18.096714],
      [50.528976, 18.096725], [50.528971, 18.096737], [50.528966, 18.096749],
      [50.528961, 18.096761], [50.528956, 18.096773], [50.528951, 18.096784],
      [50.528946, 18.096796], [50.528941, 18.096808], [50.528936, 18.09682],
      [50.528931, 18.096832], [50.528926, 18.096843], [50.528921, 18.096855],
      [50.528916, 18.096867], [50.528911, 18.096879], [50.528906, 18.096891],
      [50.528901, 18.096902], [50.528896, 18.096914], [50.528891, 18.096926],
      [50.528886, 18.096938], [50.528881, 18.09695], [50.528876, 18.096961],
      [50.528871, 18.096973], [50.528866, 18.096985], [50.528861, 18.096997],
      [50.528856, 18.097009], [50.528851, 18.09702], [50.528846, 18.097032],
      [50.528841, 18.097044], [50.528836, 18.097056], [50.528831, 18.097068],
      [50.528826, 18.097079], [50.528821, 18.097091], [50.528816, 18.097103],
      [50.528811, 18.097115], [50.528806, 18.097127], [50.528801, 18.097138],
      [50.528796, 18.09715], [50.528791, 18.097162], [50.528786, 18.097174],
      [50.528781, 18.097186], [50.528776, 18.097197], [50.528771, 18.097209],
      [50.528766, 18.097221], [50.528761, 18.097233], [50.528756, 18.097245],
      [50.528751, 18.097256], [50.528746, 18.097268], [50.528741, 18.09728],
      [50.528736, 18.097292], [50.528731, 18.097304], [50.528726, 18.097315],
      [50.528721, 18.097327], [50.528716, 18.097339], [50.528711, 18.097351],
      [50.528706, 18.097363], [50.528701, 18.097374], [50.528696, 18.097386],
      [50.528691, 18.097398], [50.528686, 18.09741], [50.528681, 18.097422],
      [50.528676, 18.097433], [50.528671, 18.097445], [50.528666, 18.097457],
      [50.528661, 18.097469], [50.528656, 18.097481], [50.528651, 18.097492],
      [50.528646, 18.097504], [50.528641, 18.097516], [50.528636, 18.097528],
      [50.528631, 18.09754], [50.528626, 18.097551], [50.528621, 18.097563],
      [50.528616, 18.097575], [50.528611, 18.097587], [50.528606, 18.097599],
      [50.528601, 18.09761], [50.528596, 18.097622], [50.528591, 18.097634],
      [50.528586, 18.097646], [50.528581, 18.097658], [50.528576, 18.097669],
      [50.528571, 18.097681], [50.528566, 18.097693], [50.528561, 18.097705],
      [50.528556, 18.097717], [50.528551, 18.097728], [50.528546, 18.09774],
      [50.528541, 18.097752], [50.528536, 18.097764], [50.528531, 18.097776],
      [50.528526, 18.097787], [50.528521, 18.097799], [50.528516, 18.097811],
      [50.528511, 18.097823], [50.528506, 18.097835], [50.528501, 18.097846],
      [50.528496, 18.097858], [50.528491, 18.09787], [50.528486, 18.097882],
      [50.528481, 18.097894], [50.528476, 18.097905], [50.528471, 18.097917],
      [50.528466, 18.097929], [50.528461, 18.097941], [50.528456, 18.097953],
      [50.528451, 18.097964], [50.528446, 18.097976], [50.528441, 18.097988],
      [50.528436, 18.098], [50.528431, 18.098012], [50.528426, 18.098023],
      [50.528421, 18.098035], [50.528416, 18.098047], [50.528411, 18.098059],
      [50.528406, 18.098071], [50.528401, 18.098082], [50.528396, 18.098094],
      [50.528391, 18.098106], [50.528386, 18.098118], [50.528381, 18.09813],
      [50.528376, 18.098141], [50.528371, 18.098153], [50.528366, 18.098165],
      [50.528361, 18.098177], [50.528356, 18.098189], [50.528351, 18.0982],
      [50.528346, 18.098212], [50.528341, 18.098224], [50.528336, 18.098236],
      [50.528331, 18.098248], [50.528326, 18.098259], [50.528321, 18.098271],
      [50.528316, 18.098283], [50.528311, 18.098295], [50.528306, 18.098307],
      [50.528301, 18.098318], [50.528296, 18.09833], [50.528291, 18.098342],
      [50.528286, 18.098354], [50.528281, 18.098366], [50.528276, 18.098377],
      [50.528271, 18.098389], [50.528266, 18.098401], [50.528261, 18.098413],
      [50.528256, 18.098425], [50.528251, 18.098436], [50.528246, 18.098448],
      [50.528241, 18.09846], [50.528236, 18.098472], [50.528231, 18.098484],
      [50.528226, 18.098495], [50.528221, 18.098507], [50.528216, 18.098519],
      [50.528211, 18.098531], [50.528206, 18.098543], [50.528201, 18.098554],
      [50.528196, 18.098566], [50.528191, 18.098578], [50.528186, 18.09859],
      [50.528181, 18.098602], [50.528176, 18.098613], [50.528171, 18.098625],
      [50.528166, 18.098637], [50.528161, 18.098649], [50.528156, 18.098661],
      [50.528151, 18.098672], [50.528146, 18.098684], [50.528141, 18.098696],
      [50.528136, 18.098708], [50.528131, 18.09872], [50.528126, 18.098731],
      [50.528121, 18.098743], [50.528116, 18.098755], [50.528111, 18.098767],
      [50.528106, 18.098779], [50.528101, 18.09879], [50.528096, 18.098802],
      [50.528091, 18.098814], [50.528086, 18.098826], [50.528081, 18.098838],
      [50.528076, 18.098849], [50.528071, 18.098861], [50.528066, 18.098873],
      [50.528061, 18.098885], [50.528056, 18.098897], [50.528051, 18.098908],
      [50.528046, 18.09892], [50.528041, 18.098932], [50.528036, 18.098944],
      [50.528031, 18.098956], [50.528026, 18.098967], [50.528021, 18.098979],
      [50.528016, 18.098991], [50.528011, 18.099003], [50.528006, 18.099015],
      [50.528001, 18.099026], [50.527996, 18.099038], [50.527991, 18.09905],
      [50.527986, 18.099062], [50.527981, 18.099074], [50.527976, 18.099085],
      [50.527971, 18.099097], [50.527966, 18.099109], [50.527961, 18.099121],
      [50.527956, 18.099133], [50.527951, 18.099144], [50.527946, 18.099156],
      [50.527941, 18.099168], [50.527936, 18.09918], [50.527931, 18.099192],
      [50.527926, 18.099203], [50.527921, 18.099215], [50.527916, 18.099227],
      [50.527911, 18.099239], [50.527906, 18.099251], [50.527901, 18.099262],
      [50.527896, 18.099274], [50.527891, 18.099286], [50.527886, 18.099298],
      [50.527881, 18.09931], [50.527876, 18.099321], [50.527871, 18.099333],
      [50.527866, 18.099345], [50.527861, 18.099357], [50.527856, 18.099369],
      [50.527851, 18.09938], [50.527846, 18.099392], [50.527841, 18.099404],
      [50.527836, 18.099416], [50.527831, 18.099428], [50.527826, 18.099439],
      [50.527821, 18.099451], [50.527816, 18.099463], [50.527811, 18.099475],
      [50.527806, 18.099487], [50.527801, 18.099498], [50.527796, 18.09951],
      [50.527791, 18.099522], [50.527786, 18.099534], [50.527781, 18.099546],
      [50.527776, 18.099557], [50.527771, 18.099569], [50.527766, 18.099581],
      [50.527761, 18.099593], [50.527756, 18.099605], [50.527751, 18.099616],
      [50.527746, 18.099628], [50.527741, 18.09964], [50.527736, 18.099652],
      [50.527731, 18.099664], [50.527726, 18.099675], [50.527721, 18.099687],
      [50.527716, 18.099699], [50.527711, 18.099711], [50.527706, 18.099723],
      [50.527701, 18.099734], [50.527696, 18.099746],
      [50.527691, 18.099758], [50.527686, 18.09977], [50.527681, 18.099782],
      [50.527676, 18.099793], [50.527671, 18.099805], [50.527666, 18.099817],
      [50.527661, 18.099829], [50.527656, 18.099841], [50.527651, 18.099852],
      [50.527646, 18.099864], [50.527641, 18.099876], [50.527636, 18.099888],
      [50.5276, 18.1001], [50.527838, 18.1001], [50.528077, 18.09942],
      [50.528317, 18.098739], [50.528556, 18.098059], [50.528796, 18.097378],
      [50.529035, 18.096698], [50.529275, 18.096017] // Retour au point de d√©part
    ];

    // Informations g√©n√©rales du circuit
    const circuitInfo = {
      nom: "Silesia Ring",
      pays: "R√©publique Tch√®que",
      distance: "1320m",
      denivele: "3.3m",
      nb_secteurs: 25,
      temps_optimal: "93.2s"
    };

    // Initialisation de la carte
    const map = L.map('map').setView(circuitConfig.centre, circuitConfig.zoom);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    // Variables globales de suivi
    let marker = null;
    let tempsDepart = null;
    let secteurActuel = 0;
    let retardAccumule = 0;
    let strategieActuelle = 'normal';
    let multiplicateurVitesse = 1.0;
    let courseEnCours = false;
    let gpsPointsCount = 0;
    let dernierPositionRecu = null;
    let lastPositionTime = null;

    // √âl√©ments DOM
    const coordsEl = document.getElementById('coords');
    const secteurEl = document.getElementById('secteur');
    const vitesseOptEl = document.getElementById('vitesse-opt');
    const tempsEl = document.getElementById('temps');
    const retardEl = document.getElementById('retard');
    const gpsPointsEl = document.getElementById('gps-points');
    const gpsAccuracyEl = document.getElementById('gps-accuracy');
    const vitesseActuelleEl = document.getElementById('vitesse-actuelle');
    const progressionEl = document.getElementById('progression');
    const tempsRestantEl = document.getElementById('temps-restant');
    const raceStatusEl = document.getElementById('race-status');
    const raceStatusTextEl = document.getElementById('race-status-text');
    const modeActuelEl = document.getElementById('mode-actuel');
    const tempsCibleEl = document.getElementById('temps-cible');

    // Dessiner le circuit complet
    const circuitLine = L.polyline(traceCircuitComplet, {
      color: '#0066cc',
      weight: 4,
      opacity: 0.8
    }).addTo(map);

    // Ajouter des marqueurs pour les secteurs avec couleurs selon le type
    function dessinerSecteurs() {
      circuitConfig.secteurs.forEach(secteur => {
        let couleur = '#28a745'; // Vert (rapide) par d√©faut
        
        switch(secteur.type) {
          case 'epingle':
            couleur = '#dc3545'; // Rouge (tr√®s lent)
            break;
          case 'lent':
            couleur = '#fd7e14'; // Orange (lent)
            break;
          case 'moyen':
            couleur = '#ffc107'; // Jaune (moyen)
            break;
          case 'rapide':
            couleur = '#28a745'; // Vert (rapide)
            break;
          case 'ligne_droite':
            couleur = '#6f42c1'; // Violet (ligne droite)
            break;
        }

        const circle = L.circle(secteur.debut, {
          radius: 8,
          fillColor: couleur,
          color: couleur,
          weight: 2,
          fillOpacity: 0.7
        }).addTo(map);

        circle.bindPopup(`
          <strong>Secteur ${secteur.id + 1}/25</strong><br>
          Type: ${secteur.type}<br>
          Vitesse optimale: ${secteur.vitesseOptimale} km/h<br>
          Temps optimal: ${secteur.tempsOptimal}s<br>
          Longueur: ${secteur.longueur}m<br>
          Rayon moyen: ${secteur.rayonMoyen}m
        `);
      });
    }

    dessinerSecteurs();

    // Fonctions utilitaires
    function calculerDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const œÜ1 = lat1 * Math.PI/180;
      const œÜ2 = lat2 * Math.PI/180;
      const ŒîœÜ = (lat2-lat1) * Math.PI/180;
      const ŒîŒª = (lon2-lon1) * Math.PI/180;

      const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                Math.cos(œÜ1) * Math.cos(œÜ2) *
                Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

      return R * c;
    }

    function determinerSecteur(lat, lon) {
      let secteurProche = 0;
      let distanceMin = Infinity;

      circuitConfig.secteurs.forEach(secteur => {
        const distance = calculerDistance(lat, lon, secteur.debut[0], secteur.debut[1]);
        if (distance < distanceMin) {
          distanceMin = distance;
          secteurProche = secteur.id;
        }
      });

      return secteurProche;
    }

    function calculerRetard(lat, lon) {
      if (!tempsDepart || !courseEnCours) return 0;

      const tempsEcoule = (Date.now() - tempsDepart) / 1000;
      const nouveauSecteur = determinerSecteur(lat, lon);

      // Calculer le temps optimal jusqu'au secteur actuel
      let tempsOptimalCumul = 0;
      for (let i = 0; i <= nouveauSecteur && i < circuitConfig.secteurs.length; i++) {
        tempsOptimalCumul += circuitConfig.secteurs[i].tempsOptimal * multiplicateurVitesse;
      }

      const retard = tempsEcoule - tempsOptimalCumul;
      
      if (nouveauSecteur !== secteurActuel) {
        secteurActuel = nouveauSecteur;
        mettreAJourAffichageSecteur();
        
        // Notifier le changement de secteur
        socket.emit('sector-update', {
          sector: secteurActuel,
          timestamp: Date.now()
        });
      }

      return retard;
    }

    function mettreAJourAffichageSecteur() {
      if (secteurActuel < circuitConfig.secteurs.length) {
        const secteur = circuitConfig.secteurs[secteurActuel];
        secteurEl.textContent = `${secteurActuel + 1}/${circuitConfig.secteurs.length}`;
        vitesseOptEl.textContent = `${Math.round(secteur.vitesseOptimale * multiplicateurVitesse)} km/h`;
        
        const progression = ((secteurActuel + 1) / circuitConfig.secteurs.length * 100);
        progressionEl.textContent = progression.toFixed(0);
        
        // Calculer le temps restant optimal
        let tempsRestantOptimal = 0;
        for (let i = secteurActuel; i < circuitConfig.secteurs.length; i++) {
          tempsRestantOptimal += circuitConfig.secteurs[i].tempsOptimal * multiplicateurVitesse;
        }
        tempsRestantEl.textContent = tempsRestantOptimal.toFixed(1);
      }
    }

    function mettreAJourAffichageRetard(retard) {
      const retardFormate = (retard >= 0 ? '+' : '') + retard.toFixed(1) + 's';
      retardEl.textContent = retardFormate;

      // Changer la couleur selon le retard
      retardEl.className = 'info-value ';
      if (retard < -2) {
        retardEl.classList.add('status-ok'); // En avance
      } else if (retard < 2) {
        retardEl.classList.add('status-ok'); // Dans les temps
      } else if (retard < 5) {
        retardEl.classList.add('status-warning'); // L√©ger retard
      } else {
        retardEl.classList.add('status-danger'); // Retard important
        
        // Alerte automatique pour retard critique
        if (retard > 10 && strategieActuelle === 'normal') {
          changeStrategy('attaque');
          showNotification('‚ö†Ô∏è Retard critique d√©tect√©! Passage automatique en mode Attaque.', 'warning');
        }
      }

      // Mise √† jour du statut de course
      if (retard < 2) {
        raceStatusEl.className = 'race-status';
        raceStatusTextEl.textContent = 'Dans les temps';
      } else if (retard < 5) {
        raceStatusEl.className = 'race-status warning';
        raceStatusTextEl.textContent = 'L√©ger retard';
      } else {
        raceStatusEl.className = 'race-status danger';
        raceStatusTextEl.textContent = 'Retard critique';
      }
    }

    function calculerVitesse(lat, lon, timestamp) {
      if (!dernierPositionRecu || !lastPositionTime) return 0;
      
      const distance = calculerDistance(
        dernierPositionRecu.lat, dernierPositionRecu.lon,
        lat, lon
      );
      
      const deltaTime = (timestamp - lastPositionTime) / 1000; // en secondes
      
      if (deltaTime > 0 && distance > 0.5) { // Ignorer les micro-mouvements
        const vitesse = (distance / deltaTime) * 3.6; // Conversion m/s -> km/h
        return Math.min(vitesse, 200); // Cap √† 200 km/h pour √©viter les aberrations
      }
      
      return 0;
    }

    function updateMarker(lat, lon, accuracy = null, timestamp = Date.now()) {
      gpsPointsCount++;
      
      // Calculer la vitesse
      const vitesse = calculerVitesse(lat, lon, timestamp);
      vitesseActuelleEl.textContent = vitesse.toFixed(0);
      
      // Mettre √† jour les coordonn√©es
      coordsEl.textContent = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
      gpsPointsEl.textContent = gpsPointsCount;
      
      if (accuracy) {
        gpsAccuracyEl.textContent = `${accuracy.toFixed(1)}m`;
      }

      // Calculer le retard
      const retard = calculerRetard(lat, lon);
      mettreAJourAffichageRetard(retard);

      // Mettre √† jour le temps √©coul√©
      if (tempsDepart && courseEnCours) {
        const tempsEcoule = (Date.now() - tempsDepart) / 1000;
        tempsEl.textContent = `${tempsEcoule.toFixed(1)}s`;
      }

      // Mettre √† jour ou cr√©er le marqueur
      if (!marker) {
        marker = L.circleMarker([lat, lon], {
          radius: 12,
          fillColor: '#ff0000',
          color: '#ffffff',
          weight: 3,
          fillOpacity: 0.9
        }).addTo(map);
        map.panTo([lat, lon]);
      } else {
        marker.setLatLng([lat, lon]);
        map.panTo([lat, lon]);
      }

      // Changer la couleur du marqueur selon le retard
      let couleurMarqueur = '#00ff00'; // Vert par d√©faut
      if (retard > 5) couleurMarqueur = '#ff0000'; // Rouge si retard
      else if (retard > 2) couleurMarqueur = '#ffa500'; // Orange si l√©ger retard
      else if (retard < -2) couleurMarqueur = '#0066ff'; // Bleu si en avance
      
      marker.setStyle({ fillColor: couleurMarqueur });

      // Stocker pour le calcul de vitesse suivant
      dernierPositionRecu = { lat, lon };
      lastPositionTime = timestamp;
    }

    // Gestion des strat√©gies
    function changeStrategy(nouvelleStrategie) {
      if (nouvelleStrategie === strategieActuelle) return;
      
      const ancienneStrategie = strategieActuelle;
      strategieActuelle = nouvelleStrategie;
      
      // Mettre √† jour les multiplicateurs de vitesse
      switch(nouvelleStrategie) {
        case 'economie':
          multiplicateurVitesse = 0.85; // -15% vitesse
          break;
        case 'normal':
          multiplicateurVitesse = 1.0;
          break;
        case 'attaque':
          multiplicateurVitesse = 1.2; // +20% vitesse
          break;
      }

      // Mettre √† jour l'interface
      document.querySelectorAll('.strategy-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelector(`.btn-${nouvelleStrategie === 'attaque' ? 'attack' : nouvelleStrategie}`)
        .classList.add('active');
      
      modeActuelEl.textContent = nouvelleStrategie.charAt(0).toUpperCase() + nouvelleStrategie.slice(1);
      
      // Recalculer le temps cible
      const tempsOptimalTotal = circuitConfig.secteurs.reduce((sum, s) => sum + s.tempsOptimal, 0);
      const tempsCible = tempsOptimalTotal * multiplicateurVitesse;
      tempsCibleEl.textContent = `${tempsCible.toFixed(1)}s`;

      // Notifier le serveur du changement de strat√©gie
      socket.emit('changement-strategie', {
        from: ancienneStrategie,
        to: nouvelleStrategie,
        multiplicateur: multiplicateurVitesse,
        secteur: secteurActuel,
        timestamp: Date.now(),
        circuit: 'Silesia Ring'
      });

      showNotification(`üéØ Strat√©gie chang√©e: ${nouvelleStrategie}`, 'success');
      console.log(`üèÅ Strat√©gie chang√©e: ${ancienneStrategie} ‚Üí ${nouvelleStrategie} (x${multiplicateurVitesse})`);
    }

    // Contr√¥les de course
    function startRace() {
      if (courseEnCours) return;
      
      courseEnCours = true;
      tempsDepart = Date.now();
      secteurActuel = 0;
      retardAccumule = 0;
      gpsPointsCount = 0;
      
      // Mise √† jour interface
      raceStatusEl.className = 'race-status';
      raceStatusTextEl.textContent = 'Course en cours';
      
      // Notification au serveur
      socket.emit('race-start', {
        timestamp: tempsDepart,
        strategy: strategieActuelle,
        circuit: 'Silesia Ring'
      });
      
      showNotification('üöÄ Course d√©marr√©e!', 'success');
      console.log('üèÅ Course d√©marr√©e sur Silesia Ring');
    }

    function stopRace() {
      if (!courseEnCours) return;
      
      courseEnCours = false;
      const duree = tempsDepart ? (Date.now() - tempsDepart) / 1000 : 0;
      
      // Mise √† jour interface
      raceStatusEl.className = 'race-status';
      raceStatusTextEl.textContent = `Arr√™t√©e (${duree.toFixed(1)}s)`;
      
      // Notification au serveur
      socket.emit('race-stop', {
        timestamp: Date.now(),
        duration: duree,
        points: gpsPointsCount,
        circuit: 'Silesia Ring'
      });
      
      showNotification(`‚èπÔ∏è Course arr√™t√©e apr√®s ${duree.toFixed(1)}s`, 'warning');
      console.log(`üèÅ Course arr√™t√©e apr√®s ${duree.toFixed(1)}s`);
    }

    function resetRace() {
      courseEnCours = false;
      tempsDepart = null;
      secteurActuel = 0;
      retardAccumule = 0;
      gpsPointsCount = 0;
      dernierPositionRecu = null;
      lastPositionTime = null;
      
      // Reset interface
      coordsEl.textContent = '--, --';
      secteurEl.textContent = '--/25';
      vitesseOptEl.textContent = '-- km/h';
      tempsEl.textContent = '--';
      retardEl.textContent = '+0.0s';
      retardEl.className = 'info-value status-ok';
      gpsPointsEl.textContent = '0';
      gpsAccuracyEl.textContent = '-- m';
      vitesseActuelleEl.textContent = '0';
      progressionEl.textContent = '0';
      tempsRestantEl.textContent = '93.2';
      raceStatusTextEl.textContent = 'En attente';
      raceStatusEl.className = 'race-status';
      
      // Supprimer le marqueur
      if (marker) {
        map.removeLayer(marker);
        marker = null;
      }
      
      socket.emit('race-reset', { circuit: 'Silesia Ring' });
      showNotification('üîÑ Course r√©initialis√©e', 'success');
      console.log('üîÑ Course r√©initialis√©e');
    }

    // Syst√®me de notifications
    function showNotification(message, type = 'info') {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = `notification ${type} show`;
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }

    // Communication WebSocket
    socket.emit('requestLatest');

    socket.on('position', (data) => {
      const { lat, lon, accuracy, timestamp } = data;
      updateMarker(lat, lon, accuracy, timestamp || Date.now());
    });

    socket.on('strategy-change', (data) => {
      console.log('üì° Changement de strat√©gie re√ßu:', data);
      if (data.to && data.to !== strategieActuelle) {
        changeStrategy(data.to);
      }
    });

    socket.on('race-start', (data) => {
      if (!courseEnCours) {
        startRace();
      }
    });

    socket.on('race-stop', (data) => {
      if (courseEnCours) {
        stopRace();
      }
    });

    socket.on('race-reset', () => {
      resetRace();
    });

    socket.on('connect', () => {
      console.log('‚úÖ Connect√© au serveur');
      showNotification('üåê Connect√© au serveur', 'success');
    });

    socket.on('disconnect', () => {
      console.log('‚ùå D√©connect√© du serveur');
      showNotification('‚ùå Connexion perdue', 'error');
    });

    // Fonctions globales pour les boutons
    window.changeStrategy = changeStrategy;
    window.startRace = startRace;
    window.stopRace = stopRace;
    window.resetRace = resetRace;

    // Initialisation
    changeStrategy('normal');
    
    console.log('üèÅ Dashboard Eta-One Racing initialis√©!');
    console.log(`üìç Circuit: ${circuitInfo.nom} (${circuitInfo.distance})`);
    console.log(`‚è±Ô∏è Temps optimal: ${circuitInfo.temps_optimal}`);
    console.log(`üéØ ${circuitConfig.secteurs.length} secteurs configur√©s`);
    console.log('‚úÖ Configuration Circuit Silesia Ring charg√©e');
  </script>
</body>
</html><!DOCTYPE html>
<html lang="fr">
<head>

  <script src="/assets/app.js"></script>
  <link rel="stylesheet" href="/assets/style.css">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Eta-One Racing - Dashboard Silesia Ring</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body, #map { margin: 0; padding: 0; height: 100vh; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    
    /* Panneau d'informations GPS */
    #info-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.95);
      padding: 15px;
      border-radius: 12px;
      font-family: 'Segoe UI', sans-serif;
      z-index: 1000;
      min-width: 300px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      border: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    #info-panel h4 {
      margin: 0 0 15px 0;
      color: #2c3e50;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 8px 0;
      padding: 4px 0;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .info-row:last-child {
      border-bottom: none;
    }
    
    .info-label {
      font-weight: 500;
      color: #555;
    }
    
    .info-value {
      font-weight: bold;
      color: #2c3e50;
    }
    
    /* Panneau de strat√©gie */
    #strategy-panel {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255, 255, 255, 0.95);
      padding: 20px;
      border-radius: 12px;
      font-family: 'Segoe UI', sans-serif;
      z-index: 1000;
      min-width: 350px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      border: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    #strategy-panel h4 {
      margin: 0 0 15px 0;
      color: #2c3e50;
      font-size: 1.2rem;
    }
    
    /* M√©triques de performance */
    .metrics-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin: 15px 0;
    }
    
    .metric-card {
      background: rgba(52, 152, 219, 0.1);
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      border: 1px solid rgba(52, 152, 219, 0.2);
    }
    
    .metric-value {
      font-size: 1.4rem;
      font-weight: bold;
      color: #2980b9;
    }
    
    .metric-label {
      font-size: 0.9rem;
      color: #7f8c8d;
      margin-top: 4px;
    }
    
    /* Boutons de strat√©gie */
    .strategy-controls {
      margin: 15px 0;
    }
    
    .strategy-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      margin: 10px 0;
    }
    
    .strategy-btn {
      padding: 12px 8px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.3s ease;
      color: white;
      text-align: center;
    }
    
    .strategy-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .strategy-btn.active {
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.8), 0 0 0 5px currentColor;
      transform: scale(1.05);
    }
    
    .btn-eco { background: linear-gradient(135deg, #27ae60, #2ecc71); }
    .btn-normal { background: linear-gradient(135deg, #3498db, #2980b9); }
    .btn-attack { background: linear-gradient(135deg, #e74c3c, #c0392b); }
    
    /* Indicateurs de statut */
    .status-ok { color: #27ae60; font-weight: bold; }
    .status-warning { color: #f39c12; font-weight: bold; }
    .status-danger { color: #e74c3c; font-weight: bold; }
    
    /* Informations de course */
    .race-status {
      background: rgba(46, 204, 113, 0.1);
      padding: 12px;
      border-radius: 8px;
      border: 1px solid rgba(46, 204, 113, 0.2);
      margin: 15px 0;
    }
    
    .race-status.warning {
      background: rgba(243, 156, 18, 0.1);
      border-color: rgba(243, 156, 18, 0.2);
    }
    
    .race-status.danger {
      background: rgba(231, 76, 60, 0.1);
      border-color: rgba(231, 76, 60, 0.2);
    }
    
    /* Contr√¥les de course */
    .race-controls {
      margin: 15px 0;
      padding: 15px 0;
      border-top: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    .control-btn {
      padding: 10px 15px;
      margin: 5px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    
    .btn-start { background: #27ae60; color: white; }
    .btn-stop { background: #e74c3c; color: white; }
    .btn-reset { background: #95a5a6; color: white; }
    
    .control-btn:hover { opacity: 0.8; transform: translateY(-1px); }
    .control-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    /* Circuit info */
    .circuit-info {
      font-size: 0.85rem;
      color: #7f8c8d;
      text-align: center;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    /* Notifications */
    .notification {
      position: absolute;
      top: 50px;
      left: 50%;
      transform: translateX(-50%);
      background: #2c3e50;
      color: white;
      padding: 15px 25px;
      border-radius: 8px;
      z-index: 10000;
      font-weight: 500;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .notification.show {
      opacity: 1;
    }
    
    .notification.success { background: #27ae60; }
    .notification.warning { background: #f39c12; }
    .notification.error { background: #e74c3c; }
  </style>
</head>
<body>
  <div id="map"></div>
  
  <!-- Panneau d'informations GPS -->
  <div id="info-panel">
    <h4>üìç Position GPS - Silesia Ring</h4>
    
    <div class="info-row">
      <span class="info-label">Coordonn√©es:</span>
      <span class="info-value" id="coords">--, --</span>
    </div
